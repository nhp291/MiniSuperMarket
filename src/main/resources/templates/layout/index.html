<!DOCTYPE html>
<html lang="VI" xmlns:th="http://www.thymeleaf.org" th:fragment="dynamic(main)">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<link rel="stylesheet" href="../css/login.css">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script>
    const app = angular.module('shoppingCartApp',[])
    app.controller('MainController',function ($scope,$http) {
        $scope.cart = {
            items: [],
            add(id){
                alert(id)
                var item = this.items.find(item => item.id == id);
                if(item){
                    item.qty++;
                    this.saveToLocalStorage()
                }else{
                    $http.get('/product/detail/{id}').then(resp =>{
                        resp.data().qty = 1;
                        this.items.push(resp.data);
                        this.saveToLocalStorage();
                    })
                }
            },
            saveToLocalStorage(){
                var json = JSON.stringify(angular.copy(this.items));
                localStorage.setItem("cart",json);
            },
        }
    })

    document.addEventListener("DOMContentLoaded", function () {
        // Hàm hiển thị giỏ hàng
        function displayCart() {
            let cart;
            try {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
            } catch (e) {
                console.error('Lỗi khi đọc dữ liệu giỏ hàng:', e);
                cart = [];
            }

            const cartContainer = document.getElementById("cart-container");
            cartContainer.innerHTML = ''; // Xóa nội dung cũ

            if (cart.length === 0) {
                cartContainer.innerHTML = "<p>Giỏ hàng của bạn đang trống.</p>";
                return;
            }

            let totalAmount = 0;

            // Hiển thị từng sản phẩm trong giỏ hàng
            cart.forEach(item => {
                const  itemUserId = item.User;
                const itemId = item.id;
                const itemName = item.name;
                const itemPrice = item.price;
                const itemQuantity = item.quantity;
                const itemTotal = itemPrice * itemQuantity;
                const itemImage = item.image;

                totalAmount += itemTotal; // Cộng dồn tổng giá trị sản phẩm

                const cartItem = document.createElement("div");
                cartItem.classList.add("cart-item");
                cartItem.innerHTML = `
                        <div>
                            <p><strong>Mã sản phẩm:</strong> ${itemImage}</p>
                            <h3>${itemName}</h3>
                            <p><strong>Giá:</strong> ${itemPrice} VND</p>
                            <p><strong>Số lượng:</strong> ${itemQuantity}</p>
                            <p><strong>Tổng:</strong> ${itemTotal} VND</p>
                        </div>
                    `;
                cartContainer.appendChild(cartItem);
            });

            // Hiển thị tổng giá trị của tất cả sản phẩm trong giỏ hàng
            const totalElement = document.createElement("p");
            totalElement.classList.add("cart-total");
            totalElement.textContent = `Tổng tiền: ${totalAmount} VND`;
            cartContainer.appendChild(totalElement);
        }

        // Hàm xóa giỏ hàng
        function clearCart() {
            localStorage.removeItem('cart');
            displayCart();
            alert("Giỏ hàng đã được xóa.");
        }

        // Dùng Event Delegation để giảm số lượng sự kiện
        document.body.addEventListener('click', function (event) {
            if (event.target.classList.contains('add-to-cart')) {
                const productUserId = event.target.getAttribute('data-accountId');
                const productId = event.target.getAttribute('data-product-id');
                const productName = event.target.getAttribute('data-product-name');
                const productPrice = Number(event.target.getAttribute('data-product-price'));
                const productImage = event.target.getAttribute('data-product-image');

                let cart = JSON.parse(localStorage.getItem('cart')) || [];

                const existingProductIndex = cart.findIndex(item => item.id === productId);

                if (existingProductIndex !== -1) {
                    alert('Bạn vừa thêm sản phẩm đã được thêm vào trước đó');
                    cart[existingProductIndex].quantity += 1;

                } else {
                    cart.push({
                        User : productUserId,
                        id: productId,
                        name: productName,
                        price: productPrice,
                        quantity: 1,
                        image: productImage
                    });
                    alert('Thêm giỏ hàng thàng công');
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                displayCart();
            }
        });

        // Hiển thị giỏ hàng khi tải trang
        displayCart();

        // Đưa hàm clearCart ra ngoài phạm vi DOMContentLoaded
        window.clearCart = clearCart;
    });

</script>
<style>

    .contact-info {
        background-color: #007bff;
        color: white;
        padding: 40px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
    }

    .contact-info h2 {
        font-size: 30px;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .contact-info p {
        margin-bottom: 10px;
        font-size: 18px;
    }

    .contact-info a {
        color: #ffffff;
        text-decoration: underline;
        transition: color 0.3s;
    }

    .contact-info a:hover {
        color: #e0e0e0;
    }

    .form-section {
        padding: 20px;
        background-color: #ffffff;
        flex: 2;
    }

    .form-section h2 {
        font-size: 28px;
        margin-bottom: 30px;
        font-weight: 600;
        color: #333;
    }

    .form-section .form-control {
        background-color: #f7f7f7;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        transition: border-color 0.3s, background-color 0.3s;
    }

    .form-section .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        background-color: #ffffff;
    }

    .form-section .btn {
        background-color: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.2s;
        font-weight: 600;
    }

    .form-section .btn:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    .footer {
        padding: 20px 0;
        text-align: center;
        background-color: #f8f9fa;
    }

    .footer a {
        color: #007bff;
        text-decoration: none;
        transition: color 0.3s;
    }

    .footer a:hover {
        color: #0056b3;
    }

    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }

        .contact-info, .form-section {
            padding: 30px;
        }

        .contact-info h2, .form-section h2 {
            font-size: 24px;
        }

        .form-section .btn {
            width: 100%;
        }
    }

    .map-section {
        width: 100%;
        height: 300px;
        margin-top: 20px;
        border-radius: 5px;
        overflow: hidden;
    }
    .card_box{
        width: 200px;
        height: 340px;
        position: relative;
        cursor: pointer;
        transition: all .3s;
    }

    .card_box:hover {
        transform: scale(0.9);
    }

    .card_box span {
        position: absolute;
        overflow: hidden;
        width: 100px;
        height: 90px;
        top: -15px;
        left: -0px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .text-success-emphasis{
        color: #679210;
    }
    hr {
        height: 4px; /* Độ dày */
        background-color: #679210; /* Màu sắc */
        border: none; /* Loại bỏ đường viền mặc định */
    }

    .card_box span::after {
        font-size: 13px;
        content: 'Giảm Giá';
        position: absolute;
        width: 150%;
        height: 40px;
        background-image: linear-gradient(45deg, #ff4769 0%, #ca252b 51%, rgba(159, 30, 30, 0.98) 100%);
        transform: rotate(-45deg) translateY(-20px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        box-shadow: 0 5px 10px rgba(0,0,0,0.23);
    }

    .card_box span::before {
        content: '';
        position: absolute;
        width: 10px;
        bottom: 0;
        left: 0;
        height: 10px;
        z-index: -1;
        box-shadow: 140px -140px #cc3f47;
        background-image: linear-gradient(45deg, #FF512F 0%, #F09819  51%, #FF512F  100%);
    }
    .select {
        width: fit-content;
        cursor: pointer;
        position: relative;
        transition: 300ms;
        color: #040302;
        overflow: hidden;
    }

    .selected {
        padding: 5px;
        margin-bottom: 3px;
        border-radius: 10px;
        border: 2px solid #706d6d;
        position: relative;
        z-index: 100000;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .options {
        display: flex;
        flex-direction: column;
        border-radius: 5px;
        background-color: #ffffff;
        border: 2px solid #706d6d;
        position: relative;
        top: -100px;
        opacity: 0;
        transition: 300ms;
    }

    .select:hover > .options {
        opacity: 1;
        top: 0;
    }

    .select:hover > .selected .arrow {
        transform: rotate(0deg);
    }

    .option {
        border-radius: 5px;
        padding: 5px;
        transition: 300ms;
        background-color: #ffffff;
        width: 150px;
        font-size: 15px;
    }
    .option:hover {
        background-color: #ffffff;
    }
    /*login*/

</style>
<body ng-app="shoppingCartApp" ng-controller="MainController">
    <header>
    <div th:replace="~{/layout/header.html}"></div>
    </header>
    <main >
        <div th:replace="${main}"></div>
    </main>

    <footer>
        <div th:replace="~{/layout/footer.html}"></div>
    </footer>
</body>
</html>